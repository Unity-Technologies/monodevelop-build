From 5b51f7345944c7eb0835640ffc3d78e5bd33a6e8 Mon Sep 17 00:00:00 2001
From: Lukasz <lukaszunity@users.noreply.github.com>
Date: Fri, 10 Jul 2015 15:36:04 +0200
Subject: [PATCH] Reset listen_socket if connecting to existing endpoint fails.

Fixes issue with a new window always being created on Windows if the first instance of MonoDevelop was started with an open file argument.
---
 main/src/core/MonoDevelop.Ide/MonoDevelop.Ide/IdeStartup.cs | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/main/src/core/MonoDevelop.Ide/MonoDevelop.Ide/IdeStartup.cs b/main/src/core/MonoDevelop.Ide/MonoDevelop.Ide/IdeStartup.cs
index 7f2e8c2..3073574 100644
--- a/main/src/core/MonoDevelop.Ide/MonoDevelop.Ide/IdeStartup.cs
+++ b/main/src/core/MonoDevelop.Ide/MonoDevelop.Ide/IdeStartup.cs
@@ -197,6 +197,15 @@ namespace MonoDevelop.Ide
 					// Reset the socket
 					if (null != socket_filename && File.Exists (socket_filename))
 						File.Delete (socket_filename);
+
+					if (options.IpcTcp) {
+						try {
+							listen_socket.Close();
+							listen_socket = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.IP);
+						} catch (Exception exc) {
+							LoggingService.LogError("Error resetting TCP socket", exc);
+						}
+					}
 				}
 			}
 			
-- 
2.2.1

